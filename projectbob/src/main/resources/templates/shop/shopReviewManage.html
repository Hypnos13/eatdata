<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/shop_layout}">
<head>
  <meta charset="UTF-8">
  <title>리뷰 관리</title>
  <link rel="stylesheet" href="/css/shopLayout.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
  <div layout:fragment="content">
    <div class="content-card">
      <h2 class="text-center mb-4">리뷰 관리</h2>
      
      <!-- 페이지당 댓글 개수 선택 -->
		<form id="pageSizeForm" th:action="@{/shop/reviewManage}" method="get" class="d-flex mb-3">
		  <input type="hidden" name="s_id"   th:value="${currentShop.sId}" />
		  <input type="hidden" name="page"   value="1" /> <!-- 사이즈 변경 시 항상 1페이지로 -->
		  <label class="me-2">댓글 개수:</label>
		  <select name="size" class="form-select w-auto"
		          onchange="this.form.submit()">
		    <option th:value="10" th:selected="${pageSize==10}">10개</option>
		    <option th:value="20" th:selected="${pageSize==20}">20개</option>
		    <option th:value="30" th:selected="${pageSize==30}">30개</option>
		  </select>
		</form>

      <!-- 리뷰가 하나도 없을 때 -->
      <div th:if="${#lists.isEmpty(reviews)}">
        <p class="text-center text-muted">등록된 리뷰가 없습니다.</p>
      </div>

      <!-- 리뷰 목록 반복 -->
      <div th:each="rev : ${reviews}" th:id="'review-' + ${rev.rNo}" class="review-card">
		  <div class="review-header">
		    <span class="review-menu-badge" th:text="${rev.menuName}">메뉴명</span>
		    <span class="review-writer" th:text="${rev.id}">ID</span>
		    <span class="review-date" th:text="${#dates.format(rev.regDate, 'yyyy-MM-dd HH:mm')}"></span>
		    <div class="review-stars">
		      <i class="bi bi-star-fill"></i>
		      <span class="score" th:text="${rev.rating}">5</span>
		      <span style="color:#b9a66e;font-weight:500;font-size:0.98em;">/5</span>
		    </div>
		  </div>
		  <div class="review-content" th:text="${rev.content}"></div>
		  <div th:if="${rev.rPicture}">
			  <img class="review-img" th:src="@{${rev.rPicture}}" alt="리뷰 사진"/>
		  </div>
		  <!-- 답글 반복 -->
			<div th:each="rp : ${rev.replies}"
			     class="reply-box"
			     th:attr="data-rrno=${rp.rrNo}, data-sid=${shop.sId}">
			  <div class="reply-header d-flex align-items-center">
			    <div>
			      <span class="reply-badge">사장님</span>
			      <span class="reply-writer" th:text="${rp.id}"></span>
			      <span class="reply-date"   th:text="${#dates.format(rp.regDate,'yyyy-MM-dd HH:mm')}"></span>
			    </div>
			    <!-- 우측: 수정/삭제 버튼 -->
			    <div class="ms-auto">
			      <button type="button" class="btn btn-sm btn-outline-success btn-edit">수정</button>
			      <button type="button" class="btn btn-sm btn-outline-danger btn-delete">삭제</button>
			    </div>
			  </div>
			
			  <!-- (A) 보여주기 전용 텍스트 -->
			  <div class="reply-content view-mode" th:text="${rp.content}"></div>
			
			  <!-- (B) 수정 모드 인풋 + 버튼 (초기엔 숨김) -->
			  <div class="edit-mode d-none">
			    <div class="input-group">
			      <input type="text" class="form-control form-control-sm edit-input"
			             th:value="${rp.content}" />
			      <button class="btn btn-sm btn-success btn-save">저장</button>
			      <button class="btn btn-sm btn-secondary btn-cancel">취소</button>
			    </div>
			  </div>
			</div>

		  <!-- 답글 등록 폼 -->
		  <form th:action="@{/shop/review/reply}" method="post" class="reply-form">
		    <input type="hidden" name="rNo" th:value="${rev.rNo}">
		    <input type="hidden" name="sId" th:value="${shop.sId}">
	        <!-- 현재 페이지/사이즈 유지 -->
		    <input type="hidden" name="page" value="<!--/*[[${currentPage}]]*/-->">
		    <input type="hidden" name="size" value="<!--/*[[${pageSize}]]*/-->">
		    <div class="input-group">
		      <input type="text" name="content" class="form-control" placeholder="사장님 답글을 입력하세요." required>
		      <button class="btn btn-submit" type="submit">등록</button>
		    </div>
		  </form>
		</div>
	  	<!-- 페이지네이션 -->
		<nav aria-label="Page navigation">
		  <ul class="pagination justify-content-center">
		    <!-- 이전 그룹 버튼 -->
		    <li class="page-item" th:classappend="${startPageGroup>1} ? '' : 'disabled'">
		      <a class="page-link"
		         th:href="@{/shop/reviewManage(
		             s_id=${currentShop.sId},
		             page=${startPageGroup-1},
		             size=${pageSize}
		         )}">«</a>
		    </li>
		    <!-- 페이지 번호 -->
		    <li class="page-item"
		        th:each="i: ${#numbers.sequence(startPageGroup, endPageGroup)}"
		        th:classappend="${i==currentPage} ? 'active'">
		      <a class="page-link"
		         th:href="@{/shop/reviewManage(
		             s_id=${currentShop.sId},
		             page=${i},
		             size=${pageSize}
		         )}"
		         th:text="${i}">1</a>
		    </li>
		    <!-- 다음 그룹 버튼 -->
		    <li class="page-item" th:classappend="${endPageGroup<totalPages} ? '' : 'disabled'">
		      <a class="page-link"
		         th:href="@{/shop/reviewManage(
		             s_id=${currentShop.sId},
		             page=${endPageGroup+1},
		             size=${pageSize}
		         )}">»</a>
		    </li>
		  </ul>
		</nav>
    </div>
  </div>
  
</body>
</html>
