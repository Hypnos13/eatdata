<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/shop_layout}">
<head>
  <meta charset="UTF-8">
  <title>리뷰 관리</title>
  <link rel="stylesheet" href="/css/shopLayout.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>

  <div layout:fragment="content">
    <div class="content-card">
      <h2 class="text-center mb-4">리뷰 관리</h2>
      
      <!-- 페이지당 개수 선택 폼 -->
	  <form th:action="@{/shop/shopReviewManage}" method="get"
	    class="mb-3 d-flex justify-content-end align-items-center">
		<input type="hidden" name="sId" th:value="${shop.sId}" />
        <label class="me-2">한 페이지에</label>
        <select name="size"
                class="form-select form-select-sm w-auto"
                onchange="this.form.submit()">
          <option th:each="opt : ${sizeOptions}"
                  th:value="${opt}"
                  th:text="${opt + '개 보기'}"
                  th:selected="${opt == selectedSize}">
          </option>
        </select>
      </form>

      <!-- 리뷰가 하나도 없을 때 -->
      <div th:if="${#lists.isEmpty(reviews)}">
        <p class="text-center text-muted">등록된 리뷰가 없습니다.</p>
      </div>

      <!-- 리뷰 목록 반복 -->
      <div th:each="rev : ${reviews}" class="review-card">
		  <div class="review-header">
		    <span class="review-menu-badge" th:text="${rev.menuName}">메뉴명</span>
		    <span class="review-writer" th:text="${rev.id}">ID</span>
		    <span class="review-date" th:text="${#dates.format(rev.regDate, 'yyyy-MM-dd HH:mm')}"></span>
		    <div class="review-stars">
		      <i class="bi bi-star-fill"></i>
		      <span class="score" th:text="${rev.rating}">5</span>
		      <span style="color:#b9a66e;font-weight:500;font-size:0.98em;">/5</span>
		    </div>
		  </div>
		  <div class="review-content" th:text="${rev.content}"></div>
		  <div th:if="${rev.rPicture}">
			  <img class="review-img" th:src="@{'/images/review/' + ${rev.rPicture}}" alt="리뷰 사진"/>
		  </div>
		  <!-- 답글 반복 -->
			<div th:each="rp : ${rev.replies}"
			     class="reply-box"
			     th:attr="data-rrno=${rp.rrNo}, data-sid=${shop.sId}">
			  <div class="reply-header d-flex align-items-center">
			    <div>
			      <span class="reply-badge">사장님</span>
			      <span class="reply-writer" th:text="${rp.id}"></span>
			      <span class="reply-date"   th:text="${#dates.format(rp.regDate,'yyyy-MM-dd HH:mm')}"></span>
			    </div>
			    <!-- 우측: 수정/삭제 버튼 -->
			    <div class="ms-auto">
			      <button type="button" class="btn btn-sm btn-outline-primary btn-edit">수정</button>
			      <button type="button" class="btn btn-sm btn-outline-danger btn-delete">삭제</button>
			    </div>
			  </div>
			
			  <!-- (A) 보여주기 전용 텍스트 -->
			  <div class="reply-content view-mode" th:text="${rp.content}"></div>
			
			  <!-- (B) 수정 모드 인풋 + 버튼 (초기엔 숨김) -->
			  <div class="edit-mode d-none">
			    <div class="input-group">
			      <input type="text" class="form-control form-control-sm edit-input"
			             th:value="${rp.content}" />
			      <button class="btn btn-sm btn-success btn-save">저장</button>
			      <button class="btn btn-sm btn-secondary btn-cancel">취소</button>
			    </div>
			  </div>
			</div>

		  <!-- 답글 등록 폼 -->
		  <form th:action="@{/shop/review/reply}" method="post" class="reply-form">
		    <input type="hidden" name="rNo" th:value="${rev.rNo}">
		    <input type="hidden" name="sId" th:value="${shop.sId}">
		    <div class="input-group">
		      <input type="text" name="content" class="form-control" placeholder="사장님 답글을 입력하세요." required>
		      <button class="btn btn-submit" type="submit">등록</button>
		    </div>
		  </form>
		</div>
		
		<!-- 페이징 네비게이션 -->
		<nav aria-label="Page navigation">
		  <ul class="pagination justify-content-center">
		    <!-- 이전 블록 -->
		    <li class="page-item" th:classappend="${startPage > 1} ? '' : 'disabled'">
		      <a class="page-link"
		         th:if="${startPage > 1}"
		         th:href="@{/shop/shopReviewManage(sId=${shop.sId}, page=${startPage-1}, size=${selectedSize})}">
		        «
		      </a>
		      <span class="page-link" th:unless="${startPage > 1}">«</span>
		    </li>
		
		    <!-- 페이지 번호 -->
		    <li class="page-item" th:each="i : ${pageList}" th:classappend="${i == currentPage} ? 'active'">
		      <a class="page-link"
		         th:href="@{/shop/shopReviewManage(sId=${shop.sId}, page=${i}, size=${selectedSize})}"
		         th:text="${i}">1</a>
		    </li>
		
		    <!-- 다음 블록 -->
		    <li class="page-item" th:classappend="${endPage < totalPages} ? '' : 'disabled'">
		      <a class="page-link"
		         th:if="${endPage < totalPages}"
		         th:href="@{/shop/shopReviewManage(sId=${shop.sId}, page=${endPage+1}, size=${selectedSize})}">
		        »
		      </a>
		      <span class="page-link" th:unless="${endPage < totalPages}">»</span>
		    </li>
		  </ul>
		</nav>
		
    </div>
  </div>

</body>
</html>
