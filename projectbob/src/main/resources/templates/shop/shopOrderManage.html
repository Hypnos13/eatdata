<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/shop_layout}">
<head>
  <meta charset="UTF-8">
  <title>ì£¼ë¬¸ ê´€ë¦¬</title>
  <style>
      .main-container { display: flex; height: calc(100vh - 70px); }
      .order-list-panel {
        width: 360px;
        background: #fff;
        border-right:1px solid #dee2e6;
        display: flex;
        flex-direction: column;
      }
      .order-list-header {
        padding:1rem;
        font-weight:bold;
        border-bottom:1px solid #dee2e6;
      }
      .order-list { overflow-y:auto; flex-grow:1; }
      .order-card {
        padding:.75rem 1rem;
        border-bottom:1px solid #e9ecef;
        cursor:pointer;
        transition:background .2s;
        text-decoration:none;
        color:inherit;
        display:block;
      }
      .order-card:hover { background:#f8f9fa; }
      .order-card.active {
        background:#e6f9f2;
        border-left:4px solid #43D091;
      }
      .order-card-title {
        font-weight:bold;
        display:flex;
        justify-content:space-between;
      }
      .order-card-detail {
        font-size:.9rem;
        color:#495057;
        margin-top:.25rem;
      }
      .order-detail-panel {
        flex-grow:1;
        padding:2rem;
        background:#fafafa;
        overflow-y:auto;
      }
      /* íƒ€ì„ë¼ì¸ */
      .status-steps {
        display:flex;
        counter-reset:step;
        margin:2rem 0;
        list-style:none;
        padding:0;
      }
      .status-steps li {
        position:relative;
        flex:1;
        text-align:center;
      }
      .status-steps li:before {
        counter-increment:step;
        content:counter(step);
        width:2rem; height:2rem; line-height:2rem;
        border:2px solid #ccc;
        border-radius:50%;
        background:#fff;
        display:block;
        margin:0 auto;
        z-index:1;
      }
      .status-steps li:after {
        content:'';
        position:absolute;
        width:100%; height:2px;
        background:#ccc;
        top:1rem; left:-50%;
        z-index:0;
      }
      .status-steps li:first-child:after { display:none; }
      .status-steps li.completed:before,
      .status-steps li.completed:after {
        background:#43D091;
        border-color:#43D091;
      }
      .status-steps li span {
        display:block;
        margin-top:.5rem;
        font-size:.9rem;
      }
      .btn-group { margin-top:1.5rem; }
    </style>
</head>
<body>
	<th:block layout:fragment="content">
	  <div class="main-container">
	    
	    <!-- ì¢Œì¸¡: ìƒíƒœ í•„í„° & ë¦¬ìŠ¤íŠ¸ -->
	    <div class="order-list-panel">
	      <div class="order-list-header">
	        <i class="bi bi-receipt"></i>
	        ì£¼ë¬¸ ê´€ë¦¬
	        <span th:text="${status}">ACCEPTED</span>
	      </div>
	      <div class="btn-group w-100 mb-2">
	        <a th:href="@{/shop/orderManage(status='ACCEPTED')}"
	           th:classappend="${status=='ACCEPTED'}?'btn-primary':'btn-outline-primary'"
	           class="btn">ğŸ³ ì¡°ë¦¬ ì¤‘</a>
	        <a th:href="@{/shop/orderManage(status='DELIVERING')}"
	           th:classappend="${status=='DELIVERING'}?'btn-primary':'btn-outline-primary'"
	           class="btn">ğŸšš ë°°ë‹¬ ì¤‘</a>
	        <a th:href="@{/shop/orderManage(status='COMPLETED')}"
	           th:classappend="${status=='COMPLETED'}?'btn-primary':'btn-outline-primary'"
	           class="btn">âœ… ì™„ë£Œ</a>
	      </div>
	      <div class="order-list">
	        <div th:if="${#lists.isEmpty(orders)}"
	             class="text-center text-muted p-4">
	          ì¡°íšŒëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.
	        </div>
	        <a th:each="o,iter : ${orders}"
	           th:href="@{|/shop/orderManage?status=${status}&oNo=${o.oNo}|}"
	           class="order-card"
	           th:classappend="(selectedOrder?.oNo == o.oNo) or (selectedOrder==null and iter.index==0) ? ' active'">
	          <div class="order-card-title">
	            <span>ì£¼ë¬¸ #<span th:text="${o.oNo}"></span></span>
	            <span th:text="${o.payment}"></span>
	          </div>
	          <div class="order-card-detail">
	            <div th:text="${#dates.format(o.regDate,'yyyy-MM-dd HH:mm')}"></div>
	            <div th:text="${o.oAddress}"></div>
	          </div>
	        </a>
	      </div>
	    </div>
	    
	    <!-- ìš°ì¸¡ ìƒì„¸ íŒ¨ë„ -->
	    <div class="order-detail-panel">

	      <th:block th:if="${selectedOrder!=null}">
	        <h4>ì£¼ë¬¸ë²ˆí˜¸ <span th:text="${selectedOrder.oNo}"></span></h4>

	        <!-- íƒ€ì„ë¼ì¸ -->
	        <ul class="status-steps">
	          <li th:classappend="${selectedOrder.status=='ACCEPTED' 
	                              or selectedOrder.status=='DELIVERING' 
	                              or selectedOrder.status=='COMPLETED'} ? 'completed'">
	            <span>ì¡°ë¦¬ ì¤‘</span>
	          </li>
	          <li th:classappend="${selectedOrder.status=='DELIVERING' 
	                              or selectedOrder.status=='COMPLETED'} ? 'completed'">
	            <span>ë°°ë‹¬ ì¤‘</span>
	          </li>
	          <li th:classappend="${selectedOrder.status=='COMPLETED'} ? 'completed'">
	            <span>ì™„ë£Œ</span>
	          </li>
	        </ul>

	        <!-- ì£¼ë¬¸ ì •ë³´ -->
	        <p><strong>ì£¼ë¬¸ì¼ì‹œ:</strong>
	          <span th:text="${#dates.format(selectedOrder.regDate,'yyyy-MM-dd HH:mm')}"></span>
	        </p>
	        <p><strong>ë°°ë‹¬/í”½ì—…:</strong>
	          <span th:text="${selectedOrder.oAddress!=null?'ë°°ë‹¬':'í”½ì—…'}"></span>
	        </p>
	        <p th:if="${selectedOrder.oAddress}">
	          <strong>ì£¼ì†Œ:</strong>
	          <span th:text="${selectedOrder.oAddress}"></span>
	        </p>
	        <p><strong>ì´ì•¡/ìˆ˜ëŸ‰:</strong>
	          <span th:text="${selectedOrder.totalPrice + 'ì›'}"></span> /
	          <span th:text="${selectedOrder.quantity + 'ê°œ'}"></span>
	        </p>
	        <p><strong>ë©”ë‰´:</strong>
	          <span th:utext="${selectedOrder.menus}"></span>
	        </p>
	        <p><strong>ìš”ì²­ì‚¬í•­:</strong>
	          <span th:text="${selectedOrder.request ?: 'ì—†ìŒ'}"></span>
	        </p>

			<!-- ìƒíƒœ ë³€ê²½ ë²„íŠ¼ -->
			<div class="btn-group">
			  <button th:if="${selectedOrder.status=='ACCEPTED'}"
			          class="btn btn-warning me-2"
			          type="button"
			          th:onclick="|location.href='@{/shop/orderManage/{oNo}/status(oNo=${selectedOrder.oNo},newStatus=DELIVERING)}'|">
			    ğŸšš ë°°ë‹¬ ì‹œì‘
			  </button>

			  <button th:if="${selectedOrder.status=='DELIVERING'}"
			          class="btn btn-success me-2"
			          type="button"
			          th:onclick="|location.href='@{/shop/orderManage/{oNo}/status(oNo=${selectedOrder.oNo},newStatus=COMPLETED)}'|">
			    âœ… ë°°ë‹¬ ì™„ë£Œ
			  </button>
			</div>
	      </th:block>

	      <th:block th:if="${selectedOrder==null}">
	        <div class="text-center text-muted p-5">
	          ì™¼ìª½ì—ì„œ ì£¼ë¬¸ì„ ì„ íƒí•˜ì„¸ìš”.
	        </div>
	      </th:block>
	    </div>

	  </div>
	</th:block>

	<!-- WebSocket/STOMP ìŠ¤í¬ë¦½íŠ¸ -->
	<script th:inline="javascript">
  /*<![CDATA[*/
    const shopId         = /*[[${currentShop.sId}]]*/ 0;
    let selectedOrderNo  = /*[[${selectedOrder!=null?selectedOrder.oNo:0}]]*/ 0;

    const sock = new SockJS('[[${#request.contextPath}]]/ws');
    const client = Stomp.over(sock);

    client.connect({}, () => {
      if (selectedOrderNo > 0) {
        client.subscribe('/topic/orderStatus/' + selectedOrderNo, () => location.reload());
      }
      client.subscribe('/topic/orderStatus/shop/' + shopId, () => location.reload());
    });

    function changeStatus(oNo, newStatus) {
      // ê°„ë‹¨í•˜ê²Œ GET ë¦¬ë‹¤ì´ë ‰íŠ¸ ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬
      window.location.href = `/shop/orderManage/${oNo}/status?newStatus=${newStatus}&status=${status}&oNo=${oNo}`;
    }
  /*]]>*/
  </script>
</body>
</html>
