<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/shop_layout}"> <th:block layout:fragment="content">

    <div class="row my-5" id="global-content">
        <div class="col">
            <div class="row my-3 text-center">
                <div class="col">
                    <h2 class="fs-3 fw-bold">메뉴 등록</h2>
                </div>
            </div>
            <div th:if="${errorMessage}" class="alert alert-danger text-center">
                <span th:text="${errorMessage}"></span>
            </div>
            <div th:if="${message}" class="alert alert-success text-center">
                <span th:text="${message}"></span>
            </div>

            <form action="/shop/insertMenu" name="menuRegisterForm" method="post" id="menuRegisterForm"
                  enctype="multipart/form-data" th:object="${menu}">
                <div class="row my-3">
                    <div class="col-8 offset-2">
                        <label for="sId" class="form-label">* 가게ID(임시) : </label>
                        <input type="text" class="form-control" name="sId" id="sId" th:field="*{sId}" required>
                    </div>
                </div>
                <div class="row my-3">
                    <div class="col-8 offset-2">
                        <label for="category" class="form-label">* 카테고리 : </label>
                        <input type="text" class="form-control" name="category" id="category" th:field="*{category}" required>
                    </div>
                </div>
                <div class="row my-3">
                    <div class="col-8 offset-2">
                        <label for="name" class="form-label">* 메뉴 이름 : </label>
                        <input type="text" class="form-control" name="name" id="name" th:field="*{name}" required>
                    </div>
                </div>
                <div class="row my-3">
                    <div class="col-8 offset-2">
                        <label for="price" class="form-label">* 가격 : </label>
                        <input type="number" class="form-control" name="price" id="price" th:field="*{price}" required>
                    </div>
                </div>
                <div class="row my-3">
                    <div class="col-8 offset-2">
                        <label for="mInfo" class="form-label">* 메뉴 설명 : </label>
                        <textarea class="form-control" name="mInfo" id="mInfo" rows="5" th:field="*{mInfo}"></textarea>
                    </div>
                </div>
                <div class="row my-3">
                    <div class="col-8 offset-2">
                        <label for="mPicture">* 메뉴 사진 : </label>
                        <input type="file" id="mPicture" name="mPicture" class="form-control">
                    </div>
                </div>

                <div class="row my-3">
                    <div class="col-8 offset-2">
                        <label class="form-label">메뉴 옵션:</label>
                        <div id="menuOptionsContainer">
                            </div>
                        <button type="button" class="btn btn-success mt-2" id="addOptionBtn">옵션 추가</button>
                    </div>
                </div>

                <div class="row mb-3 mt-5">
                    <div class="col-8 offset-2">
                        <input type="submit" value="메뉴 등록하기" class="btn btn-primary">
                        <a href="/menu/list" class="btn btn-secondary">목록으로</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const addOptionBtn = document.getElementById('addOptionBtn');
            const optionsContainer = document.getElementById('menuOptionsContainer');
            let optionIndex = 0; // 옵션 인덱스

            // 옵션 추가 함수
            function addOptionRow(moId = 0, mOption = '', content = '', price = '', status = 'active') {
                const newOptionDiv = document.createElement('div');
                newOptionDiv.classList.add('input-group', 'mb-2', 'menu-option-item');
                newOptionDiv.innerHTML = `
                    <input type="hidden" name="options[${optionIndex}].moId" value="${moId}" />
                    <input type="text" name="options[${optionIndex}].mOption" class="form-control" placeholder="옵션 이름 (예: 사이즈)" value="${mOption}" required/>
                    <input type="text" name="options[${optionIndex}].content" class="form-control" placeholder="옵션 내용 (예: Large)" value="${content}" required/>
                    <input type="number" name="options[${optionIndex}].price" class="form-control" placeholder="가격" value="${price}" />
                    <input type="hidden" name="options[${optionIndex}].status" value="${status}" />
                    <button type="button" class="btn btn-outline-danger remove-option-btn">삭제</button>
                `;
                optionsContainer.appendChild(newOptionDiv);
                optionIndex++;
            }

            // 초기 로드 시 기존 옵션 추가 (수정 폼에서 활용)
            /* 이 부분은 등록 폼이므로 초기에는 옵션이 없을 것입니다.
               만약 오류 등으로 다시 폼이 로드될 때 기존 입력값을 유지하고 싶다면,
               컨트롤러에서 Model에 menu.options를 담아보내고,
               아래와 같이 th:each를 사용하여 옵션을 미리 렌더링할 수 있습니다.
            <div class="input-group mb-2 menu-option-item" th:each="option, stat : *{options}">
                <input type="hidden" th:field="*{options[__${stat.index}__].moId}" />
                <input type="text" th:field="*{options[__${stat.index}__].mOption}" class="form-control" placeholder="옵션 이름 (예: 사이즈)" />
                <input type="text" th:field="*{options[__${stat.index}__].content}" class="form-control" placeholder="옵션 내용 (예: Large)" />
                <input type="number" th:field="*{options[__${stat.index}__].price}" class="form-control" placeholder="가격" />
                <input type="hidden" th:field="*{options[__${stat.index}__].status}" value="active" />
                <button type="button" class="btn btn-outline-danger remove-option-btn">삭제</button>
            </div>
            // 그리고 JavaScript의 optionIndex 초기화 부분을 optionsContainer.children.length; 로 변경
            */


            // "옵션 추가" 버튼 이벤트 리스너
            addOptionBtn.addEventListener('click', function () {
                addOptionRow(); // 새로운 빈 옵션 추가
            });

            // "삭제" 버튼 이벤트 위임 (동적으로 생성될 버튼에 대해)
            optionsContainer.addEventListener('click', function (event) {
                if (event.target.classList.contains('remove-option-btn')) {
                    const optionItem = event.target.closest('.menu-option-item');
                    if (optionItem) {
                        // 실제 삭제 대신 status를 'deleted'로 변경 (서버에서 이 상태를 보고 처리)
                        const moIdInput = optionItem.querySelector('input[name$=".moId"]');
                        const statusInput = optionItem.querySelector('input[name$=".status"]');

                        if (moIdInput && parseInt(moIdInput.value) > 0) {
                            // 기존 옵션인 경우 (moId가 0보다 크면 기존 옵션)
                            if (statusInput) {
                                statusInput.value = 'deleted'; // 상태를 'deleted'로 변경
                            }
                            optionItem.style.display = 'none'; // 화면에서 숨김
                        } else {
                            // 새로 추가된 옵션인 경우 (moId가 0이거나 없으면 새로 추가된 옵션)
                            optionItem.remove(); // DOM에서 즉시 제거
                        }
                        // 인덱스 재정렬 함수 호출 (옵션 중간 삭제 시)
                        reindexOptions();
                    }
                }
            });

            // 폼 제출 전에 input들의 name 속성 인덱스를 재정렬하는 함수
            // (동적으로 삭제했을 때 중간에 비어버린 인덱스를 채워줌)
            function reindexOptions() {
                const activeOptionItems = optionsContainer.querySelectorAll('.menu-option-item');
                let currentIndex = 0;
                activeOptionItems.forEach(item => {
                    if (item.style.display !== 'none') { // 화면에 보이는(삭제되지 않은) 항목만
                        item.querySelectorAll('input').forEach(input => {
                            const currentName = input.name;
                            // options[숫자] 패턴을 찾아서 새로운 숫자로 교체
                            input.name = currentName.replace(/options\[\d+\]/, `options[${currentIndex}]`);
                        });
                        currentIndex++;
                    }
                });
                optionIndex = currentIndex; // 다음 추가될 옵션의 인덱스 업데이트
            }
        });
    </script>
</th:block>
</html>