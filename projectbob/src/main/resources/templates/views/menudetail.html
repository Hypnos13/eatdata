<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/main_layout}">
<head>
<meta charset="UTF-8">
<title>메인 페이지</title>

<!-- Bootstrap CSS -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">

<!-- 사용자 정의 CSS -->
<link rel="stylesheet" href="/css/main.css">


</head>
<body>
	<div layout:fragment="content">

		<div class="container mt-4">
			<div class="row" id="global-content">
				<!-- 왼쪽: 메뉴 영역 -->
				<div class="col-md-8">

					<div class="d-flex align-items-center mb-3">
						<img th:src="${shop.sPictureUrl}" alt="가게사진" width="50" />
						<div class="ms-3">
							<h5 class="mb-0">[[ ${shop.name} ]] - [[ ${shop.address1} ]]</h5>
							<small th:text="'★ ' + ${#numbers.formatDecimal(reviewAvg, 1, 1)} + ' / 최소주문금액 ' + (${shop.minPrice == null} ? '0' : ${#numbers.formatInteger(shop.minPrice, 0, 'COMMA')}) + '원'"></small>
						</div>
						<input type="hidden" class="shopMinPrice" th:value="${shop.minPrice}"  />
						<!-- 찜버튼 -->
							<div class="ms-auto">									
								<button type="button" id="btnLikeList" th:data-sid="${shop.sId}" 
								class="btn btn-outline-secondary" 
								th:classappend="${liked} ? ' btn-secondary liked' : ' btn-outline-secondary'">
								<i class="bi bi-heart-fill me-1"></i>
								<span id="likeText" th:text="${liked} ? '찜' : '찜 하기'">()찜</span>			
								(<span id="likeCount" th:text="${heartCount}">0</span>)						
								</button>
							</div>
						
					</div>

					<!-- 탭 메뉴 -->
					<ul class="nav nav-tabs w-100 justify-content-between">
						<li class="nav-item flex-fill text-center"><a
							class="nav-link active" data-bs-toggle="tab" href="#menu">메뉴</a>
						</li>
						<li class="nav-item flex-fill text-center"><a
							class="nav-link" data-bs-toggle="tab" href="#review">클린리뷰</a></li>
						<li class="nav-item flex-fill text-center"><a
							class="nav-link" data-bs-toggle="tab" href="#info">정보</a></li>
					</ul>

					<div class="tab-content mt-3">
						<!-- 메뉴 탭 -->
						<div class="tab-pane fade show active" id="menu">
							<div th:each="category : ${menuByCategory.keySet()}">
								<h4 class="my-4 menu-category-title" th:text="${#strings.contains(category, '.')} ? ${#strings.substringAfter(category, '.')} : ${category}">카테고리명</h4>
								<div class="row">
									<div class="col-md-6 mb-4" th:each="menu : ${menuByCategory.get(category)}">
										<div class="card text-center p-3 menu-card position-relative"
											th:attr="
                                            data-id=${menu.mId},
                                            data-name=${menu.name},
                                            data-price=${menu.price},
                                            data-shop-id=${menu.sId},
                                            data-image=${menu.mPictureUrl},
                                            data-info=${menu.mInfo}"
											th:style="${menu.status != '판매중'} ? 'pointer-events: none;' : ''">
											
											<!-- 품절 오버레이 -->
											      <div th:if="${menu.status != '판매중'}"
											           class="position-absolute top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 
											                  d-flex justify-content-center align-items-center text-white fw-bold fs-4 rounded"
											           style="z-index: 10;">
											        품절
											      </div>

											<div
												class="d-flex justify-content-between align-items-center mb-2">
												<span class="menu-title">[[ ${menu.name} ]]</span>
											</div>

											<img th:src="${menu.mPictureUrl}" alt="메뉴 사진"
												class="img-fluid mb-2" />

											<div class="fw-semibold">[[ ${menu.mInfo} ]]</div>

											<div class="menu-price">[[
												${#numbers.formatInteger(menu.price, 0, 'COMMA')} ]]원</div>
										</div>
									</div>
								</div>
							</div>
						</div>

						<!-- 리뷰 탭 -->
						<div class="tab-pane fade" id="review">

						<!-- 리뷰 탭 상단 -->
						<div class="border rounded p-3 mb-3 bg-white">
							<div class="d-flex align-items-center mb-2 justify-content-between" >
								<div class="d-flex align-items-center">
									<span class="fs-4 text-warning me-2">
										<i class="bi bi-star-fill"></i>
									</span>								
											<span class="fs-5">별점&nbsp; </span>	
								<h2 class="fw-bold me-3" th:text="${#numbers.formatDecimal(reviewAvg, 1, 1)}">4.9</h2>
													
							</div>
							<!-- 하트버튼 -->
							<!-- <div class="d-flex align-items-center">						
							<span>가게 좋아요</span>		
								<button type="button" id="btnHeart" class="btn btn-outline-danger btn-sm px-2 py-0"
														th:data-sid="${shop.sId}">
								<span class="me-1" id="heartCount" th:text="${shop.heart}">0</span>
									<i class="bi bi-heart-fill"></i>
								</button>
							</div> -->
							</div>
							<div>
								리뷰 <span th:text="${reviewList.size()}">0</span>개
							</div>
						</div>
						
												<!-- 댓글쓰기 -->
						<div class="row my-3">
						<div class="col border p-1 text-center">
						<th:block th:if="${hasOrdered}">
							<span id="reviewWrite" class="text-success" style="cursor: pointer;">
								<i class="bi bi-file-earmark-text-fill" style="color: cornflowerblue;"></i>리뷰쓰기
							</span>
						</th:block>
						<th:block th:unless="${hasOrdered}">
							<p class="text-muted">리뷰는 구매 내역이 있는 고객만 작성할 수 있습니다.</p>
						</th:block>
						</div>
						</div>
						<!-- 댓글 헤더 영역 -->						
			<div id="reviewFormOriginalContainer">
						<!-- 댓글 쓰기 폼 -->
					<div class="row my-3 d-none" id="reviewForm" th:if="${member != null and hasOrdered}">
						<div class="col">
							<form name="reviewWriteForm" id="reviewWriteForm" enctype="multipart/form-data">
								<input type="hidden" name="sId" id="shopId" th:value="${shop.sId}">
						  	<input type="hidden" name="id" th:value="${member?.id}">
						  	<input type="hidden" id="loginId" th:value="${member != null ? member.id : ''}">
						  	<input type="hidden" id="reviewFormMode" value="댓글쓰기">
						  	<input type="hidden" id="shopOwnerId" th:value="${shop.id}">
						  	<!-- <input type="hidden" name="mId" th:value="${menu.mId}"> -->			
								<div class="row bg-light my-3 p-3 border">
									<div class="col">
										<div class="row">
											<div class="col text-center">
											
											<!-- 주문했던 메뉴 선택 (리뷰 가능한 주문) -->
						<div class="mb-2">
							<label class="form-label">리뷰할 주문 선택</label>
								<select name="oNo" id="reviewOrdersSelect" class="form-select" required>
									<option value="">주문을 선택하세요</option>
									<th:block th:each="order : ${reviewableOrders}">
										<option th:if="${!reviewedOrders[order.oNo]}" th:value="${order.oNo}" th:text="${order.orderName}"></option>
									</th:block>
								</select>
						</div>
						
											<!-- 별점 영역 -->
						<div class="mb-2">
							<label class="form-label">별점</label>
							<div id="starRating" class="star-rating">
								<input type="radio" name="rating" id="star5" value="5"><label for="star5">&#9733;</label>
								<input type="radio" name="rating" id="star4" value="4"><label for="star4">&#9733;</label>
								<input type="radio" name="rating" id="star3" value="3"><label for="star3">&#9733;</label>
								<input type="radio" name="rating" id="star2" value="2"><label for="star2">&#9733;</label>
								<input type="radio" name="rating" id="star1" value="1"><label for="star1">&#9733;</label>
							</div>
						</div>
						<!-- 사진 -->
						<div class="mb-2">
							<label for="rPicture" class="form-label">사진 첨부</label>
							<input type="file" name="reviewUploadFile" id="rPicture" accept="image*" class="form-control">
							<!-- 썸네일 -->
							<img id="imgPreview" style="display:none; max-width:100px; margin-top:8px;">
						</div>
												
											</div>
										</div>
										<div class="row my-3">
											<div class="col-md-10">
												<textarea name="content" id="reviewContent" class="form-control" rows="4"></textarea>												
											</div>
											<div class="col-md">
												<input type="submit" value="댓글쓰기" class="btn btn-success h-100 w-100" id="reviewSubmitButton">
											</div>
										</div>
									</div>
								</div>
							</form>
						</div>
					</div>
		</div>
		
							<!-- 리뷰 리스트 -->
						<!-- <div id="reviewList" th:if="${not #lists.isEmpty(reviewList)}"> -->
						<div id="reviewList">
							<div th:each="review : ${reviewList}" class="reviewRow border-bottom pb-3 mb-3">
								<div class="d-flex align-items-center mb-1">
									<span class="fw-bold" th:text="${#strings.substring(review.id,0,2) + '**님'}">ad**님</span>
									<span class="text-muted small ms-2" th:text="${#dates.format(review.regDate, 'yyyy-MM-dd')}">날짜</span>
									<div class="ms-auto">
									<button th:if="${member != null and review.id == member.id}" class="modifyReview btn btn-outline-success btn-sm" th:data-no="${review.rNo}" th:data-ono="${review.oNo}" th:data-menus="${review.menus}">
										<i class="bi bi-journal-text">수정</i>									
									</button>
									<button th:if="${member != null and review.id == member.id }" class="deleteReview btn btn-outline-dark btn-sm" th:data-no="${review.rNo}" th:data-sid="${review.sId}">
										<i class="bi bi-trash">삭제</i>
									</button>
									<button th:unless="${member != null and review.id == member.id}" class="btn btn-outline-danger btn-sm" th:onclick="reportReview('${review.rNo}')">
										<i class="bi bi-telephone-outbound">신고</i>
									</button>
									</div>
									<!-- <span class="ms-auto text-danger small" style="cursor:pointer">신고</span> -->
								</div>
								<!-- 별점  -->
								<div class="mb-1">
									<span class="me-2 text-warning">
										<i class="bi bi-star-fill"></i>										
									</span>
									<span th:text=" ' ' + ${review.rating} +'점'" class="fw-bold ms-1"></span>
								</div>
								<!-- 리뷰 사진  -->
								<div th:if="${review.rPicture != null}">
									<img th:src="@{${review.rPicture} + '?t=' + ${now}}" alt="리뷰사진" 
													style="max-width:200px;" class="rounded shadow-sm mb-2" />
								</div>
								<!-- 메뉴 설명 -->
								<div class="text-secondary small mb-1">
									<span th:text="${review.menuName}">싹싹김치</span>
								</div>
								<!-- 리뷰 내용 -->
								<div class = "review-content" th:text="${review.content}">good day</div>
								<!-- 대댓글(사장님 전용) -->
								<div th:if="${reviewReplyMap[review.rNo] != null}" class="mt-3">
									<div class="card p-2 bg-light border-info" style="border-left:4px solid #3498db;">
										<div class="d-flex align-items-center mb-1">
											<span class="fw-bold text-primary">
												<i class="bi bi-person-badge"></i>사장님
											</span>
											<span class="text-muted small ms-2" th:text="${#dates.format(reviewReplyMap[review.rNo].regDate, 'yyyy-MM-dd HH:mm')}">날짜</span>
											<div class="ms-auto" th:if="${member != null and member.id == shop.id}">
												<button type="button" class="btn btn-outline-primary btn-sm px-3 modifyReviewReply"
																	th:data-rrno="${reviewReplyMap[review.rNo].rrNo}" th:data-rno="${review.rNo}"
																	th:data-content="${reviewReplyMap[review.rNo].content}">수정</button>
												<button type="button" class="btn btn-outline-danger btn-sm px-3 deleteReviewReply"
																	th:data-rrno="${reviewReplyMap[review.rNo].rrNo}" th:data-rno="${review.rNo}" th:data-sid="${shop.sId}">삭제</button>
											</div>										
										</div>
										<div th:text="${reviewReplyMap[review.rNo].content}" class="ms-3"></div>
									</div>
								</div>
								<div th:if="${member != null and member.id == shop.id and reviewReplyMap[review.rNo] == null}" class="mt-2 text-end">
									<button type="button" class="btn btn-outline-primary btn-sm px-2 py-0 review-reply-btn" th:data-review-no="${review.rNo}">
										<i class="bi bi-person-badge"></i>사장님 댓글쓰기
									</button>
								</div>
								<!-- 사장님 댓글쓰기 폼 -->
								<div class="reviewReplyForm d-none p-3 rounded shadow-sm" style="background:#f8fafc;">
									<form class="review-reply-form">
										<input type="hidden" name="rNo" th:value="${review.rNo}">
										<input type="hidden" name="sId" th:value="${shop.sId}">
										<input type="hidden" name="id" th:value="${shop.id}">
										<input type="hidden" name="rrNo" th:value="${reviewReplyMap[review.rNo].rrNo}" th:if="${reviewReplyMap[review.rNo] != null}">
										<div class="mb-2">
											<textarea name="content" class="form-control fs-5 py-3" rows="3" maxlength="250"
													placeholder="사장님 댓글을 입력하세요" style="resize: none;"></textarea>																				
										</div>
										<div class="text-end">
											<th:block th:if="${member != null and member.id == shop.id}">
												<button class="btn btn-success px-4 me-1 review-reply-submit-btn" type="submit">등록</button>
												<button type="button" class="btn btn-outline-primary px-4 me-1 modifyReviewReply d-none">수정</button>
												<button type="button" class="btn btn-outline-danger px-4 deleteReviewReply" th:attr="data-rrno=${reviewReplyMap[review.rNo].rrNo}" th:if="${reviewReplyMap[review.rNo] != null}" th:data-sid="${shop.sId}">삭제</button>
											</th:block>
										</div>
									</form>
								</div>
							</div><!-- 리뷰리스트 끝 -->
						</div>
						<!-- 리뷰 없을때 -->
						<!-- <div th:unless="${not #lists.isEmpty(reviewList)}" class="text-center text-muted p-5"> -->
						<div id="noReview" th:style="${not #lists.isEmpty(reviewList)} ? 'display:none;' : 'display:block;'" 
									class="text-center text-muted p-5">
							no 리뷰~
						</div>									
					
						</div>		
			

						<!-- 가게 정보 -->
						<div class="tab-pane fade" id="info">
<!-- 							
							<p>
							  <strong>가게 정보:</strong><br />
							  <div class="pre-line" th:text="${shop.sInfo}">가게에 대한 간단한 설명</div>
							</p>
							<hr />
 -->
							<!-- 공지사항 -->
							<p>
							  <strong>공지사항:</strong><br />
							  <div class="pre-line" th:text="${shop.notice}">진행 중인 이벤트</div>
							</p>
							<hr />
							
							<!-- 원산지 -->
							<p>
							  <strong>원산지:</strong><br />
							  <div class="pre-line" th:text="${shop.info}">가게의 기타 정보</div>
							</p>
							<hr />

							
							
							  <p><strong>영업시간:</strong>
							  <ul class="list-unstyled ms-3">
							    <!-- shop.sId에 맞는 openTextMap 리스트를 순회 -->
							    <li th:each="line : ${openLines}"
							        th:text="${line}">
							      <!-- 출력 예: 월요일 : 10:30 ~ 20:30 -->
							    </li>
							  </ul>
							</p>
							  <hr />
							  
							<p>
								<strong>위치:</strong> 
								<span id="storeAddress">[[${shop.address1}]] - [[${shop.address2}]]</span><br /> 
								<strong>전화:</strong>

								[[${shop.phone}]]
							</p>
							<hr />

							<div class="mt-3">
								<h6>📍 위치 지도</h6>
								<div id="map"
									style="width: 100%; height: 300px; border: 1px solid #ccc; border-radius: 10px;"></div>
							</div>
						</div>
					</div>
				</div>

				<div class="col-12 col-md-4">
				    <div class="card order-summary p-3">
				        <h5 class="card-title mb-3">주문표</h5>

				        <div class="order-item-list mb-3">
						<div class="empty-order-message text-muted fst-italic small text-center d-none">
  주문한 메뉴가 없습니다.
</div>
				            
				            <div th:each="mainItem : ${cartList}"
				                 th:if="${mainItem.caPid == null}"
				                 th:data-ca-id="${mainItem.caId}"
				                 class="pb-3 mb-3 border-bottom cart-main-item">

				                <div class="mb-2">
				                    <div class="fw-bold small mb-1"
				                         th:text="|${mainItem.menuName} : ${#numbers.formatInteger(mainItem.totalPrice, 0, 'COMMA')}원|">
				                        메인메뉴명 : 0원</div>

				                    <div th:each="optItem : ${cartList}"
				                         th:if="${optItem.caPid != null and optItem.caPid == mainItem.caId}"
				                         th:data-ca-id="${optItem.caId}"
				                         class="text-muted small ms-3 mb-1 cart-option-item"
				                         th:text="|└ 옵션: ${optItem.optionName} (${#numbers.formatInteger(optItem.totalPrice, 0, 'COMMA')}원)|">
				                        └ 옵션: 옵션명 (0원)</div>

				                    <div class="d-flex justify-content-between align-items-center mt-2">
				                        <div class="d-flex align-items-center">
				                            <button class="btn btn-outline-secondary btn-sm py-0 px-1 btn-quantity-minus"
				                                    th:data-ca-id="${mainItem.caId}" style="font-size: 0.75rem;">−</button>
				                            <input type="text"
				                                   class="form-control form-control-sm mx-1 text-center quantity-input"
				                                   th:value="${mainItem.quantity}" readonly
				                                   th:data-ca-id="${mainItem.caId}"
				                                   style="width: 32px; height: 26px; font-size: 0.75rem; padding: 0;">
				                            <button class="btn btn-outline-secondary btn-sm py-0 px-1 btn-quantity-plus"
				                                    th:data-ca-id="${mainItem.caId}" style="font-size: 0.75rem;">+</button>
				                        </div>
				                        <button class="btn btn-outline-danger btn-sm py-0 px-2 btn-delete-main-item"
				                                th:data-ca-id="${mainItem.caId}" style="font-size: 0.75rem;">x</button>
				                    </div>
				                </div>
				            </div>
				        </div>

				        <div id="totalOrderPrice" class="mb-2 fw-bold">
				            총 결제 금액: <span
				                th:text="${#numbers.formatInteger(totalPrice, 0, 'COMMA')} + '원'">0원</span>
				        </div>
				        <div id="orderSummaryInfo" class="mb-3"
				             th:classappend="${#lists.isEmpty(cartList)} ? 'd-none' : ''">
				            <small class="text-muted d-block mt-1"> (배달비 3,000원 추가) </small>
				        </div>

				        <button class="btn btn-danger w-100 btn-sm mb-2" id="btnRemoveAllItems">주문 전체 취소</button>
				        <button class="btn btn-sm w-100 text-white" type="button"  id="btnOrderNow" style="background-color: #43d091;">주문하기</button>

				        <div id="guestInfo" th:data-guest-id="${session.guestId}" th:data-user-id="${session.loginId}"></div>
				    </div>
				</div>

			</div>
		</div>

		<form id="orderForm" method="post" action="/pay" style="display: none">
			<input type="hidden" name="menuId" id="orderMenuId"> 
			<input	type="hidden" name="count" id="orderCount"> 
			<input	type="hidden" name="optionIds" id="orderOptionIds">
			<input	type="hidden" name="totalPrice" id="orderTotalPrice">
		</form>

	</div>

	</div>
	
</body>
</html>
