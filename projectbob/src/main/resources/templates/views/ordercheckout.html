<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>주문 관리</title>
  <link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
</head>
<body>
  <div class="container mt-4">
    <h2>새 주문 대기함</h2>
    <table class="table">
      <thead>
        <tr><th>주문번호</th><th>메뉴</th><th>수량</th><th>총액</th><th>주소/전화</th><th>요청사항</th><th>액션</th></tr>
      </thead>
      <tbody>
        <tr th:each="o : ${orders}">
          <td th:text="${o.orderId}">1</td>
          <td th:text="${o.menu.name}">더블버거</td>
          <td th:text="${o.count}">2</td>
          <td th:text="${#numbers.formatInteger(o.totalPrice,0,'COMMA')} + '원'">12,000원</td>
          <td>
            <div th:text="${o.address}"></div>
            <div th:text="${o.phone}"></div>
          </td>
          <td th:text="${o.request}">초인종 금지</td>
          <td>
            <button class="btn btn-success btn-sm"
                    th:attr="data-id=${o.orderId}" onclick="changeStatus(this,'accept')">
              승인
            </button>
            <button class="btn btn-danger btn-sm"
                    th:attr="data-id=${o.orderId}" onclick="changeStatus(this,'reject')">
              거절
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <script src="/webjars/sockjs-client/sockjs.min.js"></script>
  <script src="/webjars/stomp-websocket/stomp.min.js"></script>
  
  <script>
    function changeStatus(btn, action) {
      const orderId = btn.getAttribute('data-id');
      fetch(`/owner/orders/${orderId}/${action}`, { method: 'POST' })
        .then(r => r.json())
        .then(res => {
          if (res.result==='ok') {
            // 간단히 테이블 행 지우거나 버튼 비활성화
            btn.closest('tr').remove();
          }
        });
    }
    
    const shopId = 0;
    const orderId = 0;
    const socket = new SockJS('/ws-orders');
    const client = Stomp.over(socket);
    
    client.connect({}, () => {
    	client.subscribe(`/topic/orders.${shopId}`, msg => {
    		const data = JSON.parse(msg.body);
    		if(data.orderId !== orderId) return;
    		if(data.status == 'ACCEPT'){
    			window.location.href = '/end';
    		} else if(data.status == 'REJECT'){
    			document.getElementById('status').innerText = '주문이 거절되었습e';
    		}
    	});
    });
  </script>
</body>
</html>
