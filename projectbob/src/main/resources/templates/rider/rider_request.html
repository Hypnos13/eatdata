<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê°€ìƒ ë¼ì´ë” - ë°°ì°¨ ìš”ì²­ ëª©ë¡</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=2b87d757b240dd70a51d682dd3cc37ed&libraries=services"></script>
    <style>
        body { background-color: #343a40; color: white; }
        .main-container { display: flex; height: 100vh; }
        .request-list-panel { width: 380px; background-color: #212529; border-right: 1px solid #495057; display: flex; flex-direction: column; }
        .request-list-header { padding: 1rem; border-bottom: 1px solid #495057; font-size: 1.2rem; font-weight: bold; }
        .request-list { overflow-y: auto; flex-grow: 1; }
        .request-card { padding: 1rem; border-bottom: 1px solid #495057; cursor: pointer; }
        .request-card.active { background-color: #495057; }
        .detail-panel { flex-grow: 1; padding: 2rem; }
        .card { background-color: #495057; border: 1px solid #6c757d; }
        .card-header { background-color: #212529; font-weight: bold; }
        #map { width: 100%; height: 250px; border-radius: 0.375rem; }
        .btn-accept { background-color: #28a745; color: white; font-weight: bold; border: none; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="request-list-panel">
            <div class="request-list-header">ì‹ ê·œ ë°°ì°¨ ìš”ì²­</div>
            <div class="request-list" id="requestList">
                <div class="p-3 text-center text-white-50" id="no-request-placeholder">ëŒ€ê¸° ì¤‘ì¸ ë°°ì°¨ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        </div>
        <div class="detail-panel" id="detailPanel" style="display:none;">
             <div class="card w-100">
                <div class="card-header text-center fs-4">ì£¼ë¬¸ ìƒì„¸ ì •ë³´</div>
                <div class="card-body">
                    <div id="map" class="mb-3"></div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>ì£¼ë¬¸ ë²ˆí˜¸:</strong> <span id="orderId"></span></li>
                        <li class="list-group-item"><strong>í”½ì—…ì§€:</strong> <span id="shopAddress"></span><br><small class="text-white-50" id="shopPhone"></small></li>
                        <li class="list-group-item"><strong>ë„ì°©ì§€:</strong> <span id="customerAddress"></span><br><small class="text-white-50" id="customerPhone"></small></li>
                        <li class="list-group-item"><strong>í”½ì—… ì‹œê°„:</strong> <span id="pickupTime"></span></li>
                        <li class="list-group-item"><strong>ì™„ë£Œ ì‹œê°„:</strong> <span id="deliveryTime"></span></li>
                    </ul>
                    <div class="d-grid mt-3">
                        <button class="btn btn-accept fs-5" id="btnAcceptDispatch">ë°°ì°¨ ìˆ˜ë½</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
document.addEventListener('DOMContentLoaded', function() {
    const requestList = document.getElementById('requestList');
    const detailPanel = document.getElementById('detailPanel');
    const placeholder = document.getElementById('no-request-placeholder');
    let currentSelectedOrder = null;
    
    // --- ì§€ë„ ê´€ë ¨ ë³€ìˆ˜ ---
    let map, geocoder;
    let markers = []; // ì§€ë„ì— í‘œì‹œëœ ë§ˆì»¤ë“¤ì„ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ë°°ì—´

    // --- ì›¹ì†Œì¼“ ì—°ê²° ---
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
        console.log('Rider connected: ' + frame);
        stompClient.subscribe('/topic/rider/requests', function (message) {
            const dispatchInfo = JSON.parse(message.body);
            addRequestToList(dispatchInfo);
        });
    });

    // --- í•¨ìˆ˜ ì •ì˜ ---

    // ì§€ë„ì— í”½ì—…ì§€ì™€ ë„ì°©ì§€ ë§ˆì»¤ë¥¼ í‘œì‹œí•˜ê³  ë²”ìœ„ë¥¼ ì¡°ì •í•˜ëŠ” í•¨ìˆ˜
    function updateMapMarkers(shopAddress, customerAddress) {
        // 1. ê¸°ì¡´ì— ìˆë˜ ë§ˆì»¤ë“¤ì„ ì§€ë„ì—ì„œ ëª¨ë‘ ì œê±°
        markers.forEach(marker => marker.setMap(null));
        markers = [];

        // 2. ë‘ ì§€ì ì„ ëª¨ë‘ í¬í•¨í•  ìˆ˜ ìˆëŠ” ì§€ë„ì˜ ë²”ìœ„ë¥¼ ìƒì„±
        const bounds = new kakao.maps.LatLngBounds();

        // 3. í”½ì—…ì§€(ê°€ê²Œ) ì£¼ì†Œë¥¼ ì¢Œí‘œë¡œ ë³€í™˜í•˜ì—¬ íŒŒë€ìƒ‰ ë§ˆì»¤ë¡œ í‘œì‹œ
        geocoder.addressSearch(shopAddress, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                markers.push(new kakao.maps.Marker({ map: map, position: coords, title: 'í”½ì—…ì§€' }));
                bounds.extend(coords); // ì§€ë„ ë²”ìœ„ì— í”½ì—…ì§€ ì¢Œí‘œ ì¶”ê°€
                map.setBounds(bounds); // ì§€ë„ ë²”ìœ„ë¥¼ ëª¨ë“  ë§ˆì»¤ê°€ ë³´ì´ë„ë¡ ì¡°ì •
            }
        });

        // 4. ë„ì°©ì§€(ê³ ê°) ì£¼ì†Œë¥¼ ì¢Œí‘œë¡œ ë³€í™˜í•˜ì—¬ ë¹¨ê°„ìƒ‰ ë§ˆì»¤ë¡œ í‘œì‹œ
        geocoder.addressSearch(customerAddress, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                const image = new kakao.maps.MarkerImage(
                    'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png',
                    new kakao.maps.Size(64, 69), 
                    { offset: new kakao.maps.Point(27, 69) }
                );
                markers.push(new kakao.maps.Marker({ map: map, position: coords, title: 'ë„ì°©ì§€', image: image }));
                bounds.extend(coords); // ì§€ë„ ë²”ìœ„ì— ë„ì°©ì§€ ì¢Œí‘œ ì¶”ê°€
                map.setBounds(bounds); // ì§€ë„ ë²”ìœ„ë¥¼ ëª¨ë“  ë§ˆì»¤ê°€ ë³´ì´ë„ë¡ ì¡°ì •
            }
        });
    }

    // ëª©ë¡ì— ìƒˆ ìš”ì²­ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
    function addRequestToList(order) {
        if (placeholder) placeholder.style.display = 'none';
        
        const card = document.createElement('div');
        card.className = 'request-card';
        card.dataset.orderId = order.orderId;
        card.innerHTML = `<div><strong>${order.shopName}</strong></div><small>${order.shopAddress}</small>`;
        
        card.addEventListener('click', function() {
            document.querySelectorAll('.request-card').forEach(c => c.classList.remove('active'));
            card.classList.add('active');
            displayOrderDetails(order);
        });
        requestList.prepend(card);

        // ì²« ë²ˆì§¸ ìš”ì²­ì´ë©´ ìë™ìœ¼ë¡œ ìƒì„¸ ì •ë³´ í‘œì‹œ
        if (requestList.children.length === 1) {
            card.click();
        }
    }

    // ìƒì„¸ ì •ë³´ í‘œì‹œ í•¨ìˆ˜
    function displayOrderDetails(order) {
        currentSelectedOrder = order;
        detailPanel.style.display = 'block';

        // í…ìŠ¤íŠ¸ ì •ë³´ ì—…ë°ì´íŠ¸
        document.getElementById('orderId').textContent = order.orderId;
        document.getElementById('shopAddress').textContent = order.shopAddress;
        document.getElementById('shopPhone').textContent = `ğŸ“ ${order.shopPhone}`;
        document.getElementById('customerAddress').textContent = order.customerAddress;
        document.getElementById('customerPhone').textContent = `ğŸ“ ${order.customerPhone}`;
        document.getElementById('pickupTime').textContent = order.pickupTime;
        document.getElementById('deliveryTime').textContent = order.deliveryTime;

        // ì§€ë„ê°€ ì²˜ìŒ ë¡œë“œë˜ëŠ” ê²½ìš° ì´ˆê¸°í™”
        if (!map) {
            map = new kakao.maps.Map(document.getElementById('map'), { center: new kakao.maps.LatLng(37.566826, 126.9786567), level: 4 });
            geocoder = new kakao.maps.services.Geocoder();
        }
        
        // â˜…â˜…â˜… ì§€ë„ì— ë§ˆì»¤ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ í˜¸ì¶œ â˜…â˜…â˜…
        updateMapMarkers(order.shopAddress, order.customerAddress);
    }
    
    // ë°°ì°¨ ìˆ˜ë½ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('btnAcceptDispatch').addEventListener('click', async function() {
        if (!currentSelectedOrder) return;
        
        try {
            const orderId = currentSelectedOrder.orderId;
            const response = await fetch(`/rider/orders/${orderId}/accept`, {
                method: 'POST'
            });

            if (!response.ok) {
                throw new Error('ì„œë²„ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }

            const result = await response.json();
            if (result.success) {
                alert(`ì£¼ë¬¸ë²ˆí˜¸ ${orderId} ë°°ì°¨ë¥¼ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤.`);
                document.querySelector(`.request-card[data-order-id="${orderId}"]`).remove();
                detailPanel.style.display = 'none';
                if (requestList.children.length === 1 && placeholder) {
                    placeholder.style.display = 'block';
                }
            } else {
                alert(`ë°°ì°¨ ìˆ˜ë½ ì‹¤íŒ¨: ${result.message}`);
            }
        } catch (error) {
            console.error('ë°°ì°¨ ìˆ˜ë½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            alert('ë°°ì°¨ ìˆ˜ë½ ê³¼ì •ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });

    // --- í˜ì´ì§€ê°€ ì²˜ìŒ ì—´ë¦´ ë•Œì˜ ë¡œì§ ---
    // URL íŒŒë¼ë¯¸í„°ë¡œ ë°ì´í„°ê°€ ë„˜ì–´ì™”ëŠ”ì§€ í™•ì¸
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('orderId')) {
        const initialOrder = {
            orderId: urlParams.get('orderId'),
            shopName: urlParams.get('shopName'),
            shopAddress: urlParams.get('shopAddress'),
            shopPhone: urlParams.get('shopPhone'),
            customerAddress: urlParams.get('customerAddress'),
            customerPhone: urlParams.get('customerPhone'),
            pickupTime: urlParams.get('pickupTime'),
            deliveryTime: urlParams.get('deliveryTime')
        };
        addRequestToList(initialOrder);
    }
});
</script>

</body>
</html>
    
  </body>
</html>