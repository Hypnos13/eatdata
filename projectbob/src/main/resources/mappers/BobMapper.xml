<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.projectbob.mapper.BobMapper">

<delete id="deleteByUserId" parameterType="string">
    DELETE FROM cart WHERE id = #{userId}
</delete>

<delete id="deleteByGuestId" parameterType="string">
    DELETE FROM cart WHERE guest_id = #{guestId}
</delete>

<insert id="insertCart" parameterType="com.projectbob.domain.Cart" useGeneratedKeys="true" keyProperty="caId">
  INSERT INTO cart (m_id, mo_id, id, guest_id, s_id, quantity, total_price, reg_date)
  VALUES (#{mId}, #{moId}, #{id}, #{guestId}, #{sId}, #{quantity}, #{totalPrice}, NOW())
</insert>

<select id="selectCartByUserOrGuest" resultMap="CartDetailResultMap" parameterType="map">
  SELECT
    c.ca_id,
    c.m_id,
    c.mo_id,
    c.id,
    c.guest_id,
    c.s_id,
    c.quantity,
    c.status,
    c.total_price,
    m.name AS menuName,
    m.price AS menuPrice,
    mo.content AS optionName,
    mo.price AS optionPrice
  FROM cart c
  INNER JOIN menu m ON c.m_id = m.m_id
  LEFT JOIN menu_option mo ON c.mo_id = mo.mo_id
  <where>
    <if test="userId != null">
      c.id = #{userId}
    </if>
    <if test="guestId != null">
      <if test="userId != null">
        OR
      </if>
      c.guest_id = #{guestId}
    </if>
  </where>
</select>

<resultMap id="CartDetailResultMap" type="com.projectbob.domain.Cart">
  <id property="caId" column="ca_id" />
  <result property="mId" column="m_id" />
  <result property="moId" column="mo_id" />
  <result property="id" column="id" />
  <result property="guestId" column="guest_id" />
  <result property="sId" column="s_id" />
  <result property="quantity" column="quantity" />
  <result property="status" column="status" />
  <result property="totalPrice" column="total_price" />

  <!-- ðŸŸ¢ ì¶”ê°€ ì •ë³´ ë§¤í•‘ (Cart í´ëž˜ìŠ¤ì— ì¶”ê°€í•œ í•„ë“œ) -->
  <result property="menuName" column="menuName" />
  <result property="menuPrice" column="menuPrice" />
  <result property="optionName" column="optionName" />
  <result property="optionPrice" column="optionPrice" />
</resultMap>

<!-- ëŒ“ê¸€ ì¶”ê°€ ë§µí•‘ êµ¬ë¬¸ -->
<insert id="addReview" parameterType="Review">
	INSERT INTO review(id, s_id, m_id, content, rating, r_picture, liked, status)
	VALUES(#{id}, #{sId}, #{mId}, #{content}, #{rating}, #{rPicture}, #{liked}, #{status})
</insert>

<!-- í•˜íŠ¸ ë²„íŠ¼ ì¦ê°€ì‹œí‚¤ëŠ” ì¿¼ë¦¬ -->
<update id="plusHeart" parameterType="int">
	UPDATE shop SET heart = heart + 1 WHERE s_id = #{sId}
</update>
<select id="getHeartCount" parameterType="int" resultType="int">
	SELECT heart FROM shop WHERE s_id = #{sId}
</select>

<!-- ë¦¬ë·° -->
<select id="reviewList" parameterType="int" resultType="com.projectbob.domain.Review">
	SELECT review.*, menu.name AS menuName FROM review
	JOIN menu ON review.m_id = menu.m_id 
	WHERE review.s_id = #{sId} ORDER BY review.r_no DESC
</select>

<!-- ê°€ê²Œ ìƒì„¸ íŽ˜ì´ì§€ì— í•„ìš”í•œ xml -->
<select id="getMenuListByShopId" resultType="com.projectbob.domain.Menu">
	SELECT
	*
	FROM menu
	WHERE s_id = #{sId} ORDER BY m_id ASC
</select>

<!-- ëª¨ë‹¬ì°½ ë©”ë‰´ì˜µì…˜ì— í•„ìš”í•œ xml -->
<select id="getMenuOptionsByMenuId" resultType="com.projectbob.domain.MenuOption">
	SELECT
	*
	FROM menu_option
	WHERE m_id = #{mId}
	 ORDER BY price
</select>
<select id="getMenuCategoriesByShopId" resultType="java.lang.String">
	SELECT DISTINCT category FROM menu
	WHERE s_id = #{s_id} ORDER BY category
</select>
<!-- getMenuCategoriesByShopIdëŠ” ì£¼ë¬¸í‘œì— í•„ìš”í•œ xml -->

<!-- ê°€ê²Œ ë¦¬ìŠ¤íŠ¸ì—ì„œ ê°€ê²Œ ë²„íŠ¼ ëˆ„ë¥¼ë•Œ -->
<select id="getShopDetail" resultType="com.projectbob.domain.Shop">
	SELECT
	*
	FROM shop
	WHERE s_id = #{s_id}
</select>

<!-- ë©”ì¸ì—ì„œ ë²„íŠ¼ ëˆ„ë¥¼ë•Œ -->
<select id="shopList" resultType="com.projectbob.domain.Shop" parameterType="map">
	SELECT	*	FROM shop
		where 1=1
		<if test="category != null and category != 'ì „ì²´ë³´ê¸°'">
			AND category = #{category}
		</if>
		<if test="keyword != null and keyword != ''">
			AND name like concat('%', #{keyword} ,'%')
		</if>
	
	ORDER BY s_id DESC
</select>


</mapper>